<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <link rel="stylesheet" href="../static/css/ui_jk.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <div class="logo-icon"></div>
            <h2>Logo Here</h2>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#" class="nav-link active">
                    <span class="nav-icon">üè†</span>
                    Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="location.href='/map'">
                    <span class="nav-icon">üè´</span>
                    ÎÜçÏóÖÍµêÏú°Í∏∞Í¥Ä
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="location.href='/flowershop'">
                    <span class="nav-icon">üåº</span>
                    ÍΩÉÏßë ÏßÄÎèÑ
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    Setting
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">
                    <span class="nav-icon">üîí</span>
                    Privacy
                </a>
            </li>
        </ul>

        <div class="bottom-controls">
            <div class="toggle-control">
                <span>üåô Light Mode</span>
                <div class="toggle-switch"></div>
            </div>
            <a href="#" class="withdraw-btn">
                <span>üí∞ Withdraw</span>
            </a>
            <button class="logout-btn">üì§ Logout</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <h1 class="page-title">Thousand haniho</h1>
        </div>

        <div class="dashboard-grid">
            <div class="weather-card">
                <div class="weather-header">
                    <div class="weather-title">Lorem</div>
                    <div class="weather-stat">250</div>
                </div>

                <div class="metric-cards">
                    <div class="metric-card one">
                        <div style="width: 8px; height: 8px; background: #2196f3; border-radius: 50%; margin: 0 auto 5px;"></div>
                    </div>
                    <div class="metric-card two">
                        <div style="width: 8px; height: 8px; background: #2196f3; border-radius: 50%; margin: 0 auto 5px;"></div>
                    </div>
                    <div class="metric-card blue">
                        <div style="width: 8px; height: 8px; background: #2196f3; border-radius: 50%; margin: 0 auto 5px;"></div>
                    </div>
                    <div class="metric-card orange">
                        <div style="width: 8px; height: 8px; background: #ff9800; border-radius: 50%; margin: 0 auto 5px;"></div>
                    </div>
                    <div class="metric-card pink">
                        <div style="width: 8px; height: 8px; background: #e91e63; border-radius: 50%; margin: 0 auto 5px;"></div>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-card-header">
                    <h3>ÏûëÎ¨ºÎ≥Ñ ÌôòÍ≤Ω ÌèâÍ∑† Í∑∏ÎûòÌîÑ</h3>
                    <div id="regionSelector" style="margin-bottom:10px;">
                        <label for="region">ÏßÄÏó≠ ÏÑ†ÌÉù:</label>
                        <select id="region">
                            <option value="ÏÑúÏö∏">ÏÑúÏö∏</option>
                            <option value="Î∂ÄÏÇ∞">Î∂ÄÏÇ∞</option>
                            <option value="ÎåÄÍµ¨">ÎåÄÍµ¨</option>
                            <option value="Í¥ëÏ£º">Í¥ëÏ£º</option>
                            <option value="Ïù∏Ï≤ú">Ïù∏Ï≤ú</option>
                            <option value="ÎåÄÏ†Ñ">ÎåÄÏ†Ñ</option>
                        </select>
                    </div>
                </div>

                <div id="cropFilter" style="margin-bottom:10px;"></div>

                <canvas id="barChart" width="700" height="300"></canvas>
            </div>

            <div class="ranking-card">
                <div class="ranking-header">
                    <h2>Í∞ÄÍ≤© Îç∞Ïù¥ÌÑ∞</h2>
                    <button class="ranking-select-btn">SELECT</button>
                </div>
                <div class="ranking-table-wrapper">
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th data-column="rank">Î≤àÌò∏</th>
                                <th data-column="name">ÏûëÎ¨ºÎ™Ö</th>
                                <th data-column="price">ÏÜåÎß§Í∞ÄÍ≤©</th>
                                <th data-column="change">Îì±ÎùΩÎ•†</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in ranking_data %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ row.itemname }} ({{ row.unit }})</td>
                                <td>{{ row.price }}</td>
                                <td>{{ row.weekprice }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


    </div>

    
    <script>
        // Î™®Îì† nav-link ÏöîÏÜå ÏÑ†ÌÉù
        const navLinks = document.querySelectorAll('.nav-link');

        // Í∞Å ÎßÅÌÅ¨Ïóê ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Í±∏Í∏∞
        navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault(); // ÎßÅÌÅ¨ Ïù¥Îèô ÎßâÍ∏∞

            // Î™®Îì† ÎßÅÌÅ¨ÏóêÏÑú active Ï†úÍ±∞
            navLinks.forEach(item => item.classList.remove('active'));

            // ÌÅ¥Î¶≠Ìïú ÎßÅÌÅ¨ÏóêÎßå active Ï∂îÍ∞Ä
            this.classList.add('active');
        });
        });

        const toggle = document.querySelector('.toggle-switch');

        toggle.addEventListener('click', () => {
        toggle.classList.toggle('active');
        });
    </script>


    <script>
        
        const labels = {{ compare_dict.labels | tojson }};
        const tempData = {{ compare_dict.temp | tojson }};
        const humidData = {{ compare_dict.humid | tojson }};
        const solarData = {{ compare_dict.solar | tojson }};

        let selectedRegion = "ÏÑúÏö∏";
        let lastSelectedCropIndex = null;

        // ÏßÄÏó≠ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏
        document.getElementById("region").addEventListener("change", function() {
            selectedRegion = this.value;

            // ÎßàÏßÄÎßâ ÏÑ†ÌÉùÌïú ÌíàÎ™©Ïù¥ ÏûàÏúºÎ©¥ Îã§Ïãú Í∑∏Î¶¨Í∏∞
            if (lastSelectedCropIndex !== null) {
                filterChartByCrop(lastSelectedCropIndex);
            }
        });



        // Chart.js Ï¥àÍ∏∞Ìôî
        const ctx = document.getElementById('barChart').getContext('2d');
        const chartData = {
            labels: labels,
            datasets: [
                {
                label: 'Ïò®ÎèÑ_ÎÇ¥Î∂Ä (¬∞C)',
                backgroundColor: '#FF6B6B',
                data: tempData
                },
                {
                label: 'ÏÉÅÎåÄÏäµÎèÑ_ÎÇ¥Î∂Ä (%)',
                backgroundColor: '#4ECDC4',
                data: humidData
                },
                {
                label: 'ÏùºÏÇ¨Îüâ_Ïô∏Î∂Ä (W/m¬≤)',
                backgroundColor: '#FFE66D',
                data: solarData
                }
            ]
        };

        const barChart = new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 3,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        align: 'end'
                    }
                    },
                    layout: {
                    padding: {
                        top: 20,
                        right: 30,
                        left: 10,
                        bottom: 10
                    }
                }
            }
        });

        // ÌïÑÌÑ∞ Î≤ÑÌäº ÏòÅÏó≠
        const filterContainer = document.getElementById('cropFilter');

        // Î≤ÑÌäº Ïä§ÌÉÄÏùº Ìï®Ïàò
        function createButton(text, onClickFn) {
            const btn = document.createElement('button');
            btn.textContent = text;
            btn.style.margin = '5px';
            btn.style.padding = '5px 10px';
            btn.style.borderRadius = '5px';
            btn.style.border = '1px solid #ccc';
            btn.style.backgroundColor = '#f9f9f9';
            btn.style.cursor = 'pointer';
            btn.addEventListener('click', onClickFn);
            return btn;
        }

        // Ï†ÑÏ≤¥ Î≤ÑÌäº
        const allBtn = createButton('Ï†ÑÏ≤¥ Î≥¥Í∏∞', () => {
        barChart.data.labels = labels;
        barChart.data.datasets[0].data = tempData;
        barChart.data.datasets[1].data = humidData;
        barChart.data.datasets[2].data = solarData;
        barChart.update();
        });
        filterContainer.appendChild(allBtn);

        // ÏûëÎ¨ºÎ≥Ñ Î≤ÑÌäº ÏÉùÏÑ±
        labels.forEach((crop, index) => {
            const btn = createButton(crop, () => filterChartByCrop(index));
            filterContainer.appendChild(btn);
        });


        function filterChartByCrop(index) {
            lastSelectedCropIndex = index; // Ïó¨Í∏∞Ïóê Ï†ÄÏû•!

            const selectedLabel = labels[index];
            const cropTemp = tempData[index];
            const cropHumid = humidData[index];
            const cropSolar = solarData[index];

            fetch(`/api/weather?region=${selectedRegion}`)
                .then(response => response.json())
                .then(weather => {
                const realTemp = parseFloat(weather.temp_value);
                const realHumid = parseFloat(weather.humi_value);
                const realSolar = 0;

                barChart.data.labels = [selectedLabel, selectedRegion + " Ïã§ÏãúÍ∞Ñ"];
                barChart.data.datasets[0].data = [cropTemp, realTemp];
                barChart.data.datasets[1].data = [cropHumid, realHumid];
                barChart.data.datasets[2].data = [cropSolar, realSolar];
                barChart.update();
                });
        }
    </script>

    
    <script>
        document.querySelectorAll(".ranking-table th").forEach(th => {
            th.addEventListener("click", () => {
            const table = th.closest("table");
            const tbody = table.querySelector("tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));
            const index = Array.from(th.parentNode.children).indexOf(th);
            const isNumeric = index !== 1; // ÏãùÎ¨ºÎ™Ö Ï†úÏô∏ Ïà´Ïûê Ï†ïÎ†¨

            const sortedRows = rows.sort((a, b) => {
                const aText = a.children[index].textContent.trim().replace(/[%(),]/g, "");
                const bText = b.children[index].textContent.trim().replace(/[%(),]/g, "");
                if (isNumeric) {
                return parseFloat(aText) - parseFloat(bText);
                } else {
                return aText.localeCompare(bText);
                }
            });

            // Í∏∞Ï°¥ tbody ÎπÑÏö∞Í≥† Îã§Ïãú append
            tbody.innerHTML = "";
            sortedRows.forEach(row => tbody.appendChild(row));
            });
        });
    </script>
</body>
</html>