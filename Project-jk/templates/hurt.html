<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‹ë¬¼ ë³‘ ê°ì§€</title>
  <link rel="stylesheet" href="../static/css/hurt.css">
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div class="logo">
    <div class="logo-icon"></div>
  </div>
  <ul class="nav-menu">
    <li class="nav-item"><a href="/dashboard" class="nav-link"><span class="nav-icon">ğŸ </span>ëŒ€ì‰¬ë³´ë“œ</a></li>
    <li class="nav-item"><a href="/education" class="nav-link"><span class="nav-icon">ğŸ«</span>ë†ì—…êµìœ¡ê¸°ê´€</a></li>
    <li class="nav-item"><a href="/flowershop" class="nav-link"><span class="nav-icon">ğŸŒ¼</span>ê½ƒì§‘ ì§€ë„</a></li>
    <li class="nav-item"><a href="/growplant" class="nav-link">
      <span class="nav-icon"><img src="/static/images/growplant.png" alt="ì‹ë¬¼ ì„±ì¥ ì•„ì´ì½˜" style="width:21px; height:21px; vertical-align:middle;"></span>
      ì‹ë¬¼ ì„±ì¥ ì˜ˆì¸¡
    </a></li>
    <li class="nav-item"><a href="/hurt" class="nav-link"><span class="nav-icon">ğŸš‘</span>ì‹ë¬¼ ë³‘ëª… ì§„ë‹¨</a></li>
  </ul>
</div>

<!-- Main Content -->
<div class="main-content">
  <h1 class="page-title">ì‹ë¬¼ ë³‘ëª… ì§„ë‹¨ ğŸš‘</h1>

  <div class="section-wrapper">
    <div class="fruit-buttons">
      <button class="fruit-btn" data-fruit="ê·¤">ê·¤ ğŸŠ</button>
      <button class="fruit-btn" data-fruit="ë”¸ê¸°">ë”¸ê¸° ğŸ“</button>
      <button class="fruit-btn" data-fruit="ë ˆëª¬">ë ˆëª¬ ğŸ‹</button>
      <button class="fruit-btn" data-fruit="ì°¸ì™¸">ì°¸ì™¸ ğŸˆ</button>
    </div>
  </div>

  <div class="section-wrapper">
    <div class="detector-layout">
      <div class="box">
        <h2>ì´ë¯¸ì§€ ì—…ë¡œë“œ</h2>
        <input type="file" accept="image/*" id="upload" />
        <img id="preview" class="preview" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" />
        <div id="result" class="result"></div>
      </div>
      <div class="box">
        <h2>ì§„ë‹¨ ê²°ê³¼</h2>
        <p id="diagnosis-message" class="result-text">ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
      </div>
    </div>
  </div>
</div>

<script>
  const fruitButtons = document.querySelectorAll('.fruit-btn');
  const uploadInput = document.getElementById('upload');
  const previewImg = document.getElementById('preview');
  const resultDiv = document.getElementById('result');
  const diagnosisMessage = document.getElementById('diagnosis-message');
  let selectedFruit = null;

  fruitButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      fruitButtons.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      selectedFruit = btn.getAttribute('data-fruit');
      diagnosisMessage.textContent = `${selectedFruit}ì„(ë¥¼) ì„ íƒí–ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.`;
      resultDiv.textContent = '';
      uploadInput.value = '';

      // ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
      previewImg.src = "";
      previewImg.classList.remove('show');
    });
  });

  uploadInput.addEventListener('change', async e => {
    if (!selectedFruit) {
      alert('ë¨¼ì € ê³¼ì¼ì„ ì„ íƒí•˜ì„¸ìš”!');
      uploadInput.value = '';
      return;
    }
    const file = e.target.files[0];
    if (!file) {
      previewImg.style.display = 'none';
      resultDiv.textContent = '';
      diagnosisMessage.textContent = 'ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      previewImg.src = reader.result;
      previewImg.classList.add('show');
    };
    reader.readAsDataURL(file);
    const formData = new FormData();
    formData.append('fruit', selectedFruit);
    formData.append('image', file);
    diagnosisMessage.textContent = 'ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.';
    try {
      const response = await fetch('/predict', { method: 'POST', body: formData });
      if (!response.ok) throw new Error('ì„œë²„ ì—ëŸ¬ ë°œìƒ');
      const data = await response.json();
      if (data.error) {
        diagnosisMessage.textContent = data.error;
        resultDiv.textContent = '';
      } else {
        diagnosisMessage.textContent = `ë³‘ëª…: ${data.disease}`;
        resultDiv.innerHTML = `ì‹ ë¢°ë„: ${(data.confidence * 100).toFixed(2)}%`;
      }
    } catch (err) {
      diagnosisMessage.textContent = 'ì˜ˆì¸¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      resultDiv.textContent = '';
      console.error(err);
    }
  });
</script>
</body>
</html>
